% Uklid:
clc ; clear ; close all;

% Dimenze ulohu (2 stupne volnosti:u,v, 3 uzly na prvku):
ndof=2   
puzlu=3   

% ZADANI - material:
E=20e9
nu=0.2
t=0.15

% ZADANI - geometrie:
uzly=[
0.000000e+00 0.000000e+00
1.000000e-01 0.000000e+00
1.000000e-01 1.000000e-01
0.000000e+00 1.000000e-01
2.000000e-01 0.000000e+00
2.000000e-01 1.000000e-01
3.000000e-01 0.000000e+00
3.000000e-01 1.000000e-01
4.000000e-01 0.000000e+00
4.000000e-01 1.000000e-01
5.000000e-01 0.000000e+00
5.000000e-01 1.000000e-01
1.000000e-01 2.000000e-01
0.000000e+00 2.000000e-01
2.000000e-01 2.000000e-01
3.000000e-01 2.000000e-01
4.000000e-01 2.000000e-01
5.000000e-01 2.000000e-01
1.000000e-01 3.000000e-01
0.000000e+00 3.000000e-01
2.000000e-01 3.000000e-01
3.000000e-01 3.000000e-01
4.000000e-01 3.000000e-01
5.000000e-01 3.000000e-01
1.000000e-01 4.000000e-01
0.000000e+00 4.000000e-01
2.000000e-01 4.000000e-01
3.000000e-01 4.000000e-01
4.000000e-01 4.000000e-01
5.000000e-01 4.000000e-01
1.000000e-01 5.000000e-01
0.000000e+00 5.000000e-01
2.000000e-01 5.000000e-01
3.000000e-01 5.000000e-01
4.000000e-01 5.000000e-01
5.000000e-01 5.000000e-01
1.000000e-01 6.000000e-01
0.000000e+00 6.000000e-01
2.000000e-01 6.000000e-01
3.000000e-01 6.000000e-01
4.000000e-01 6.000000e-01
5.000000e-01 6.000000e-01
1.000000e-01 7.000000e-01
0.000000e+00 7.000000e-01
2.000000e-01 7.000000e-01
3.000000e-01 7.000000e-01
4.000000e-01 7.000000e-01
5.000000e-01 7.000000e-01
1.000000e-01 8.000000e-01
0.000000e+00 8.000000e-01
2.000000e-01 8.000000e-01
3.000000e-01 8.000000e-01
4.000000e-01 8.000000e-01
5.000000e-01 8.000000e-01
1.000000e-01 9.000000e-01
0.000000e+00 9.000000e-01
2.000000e-01 9.000000e-01
3.000000e-01 9.000000e-01
4.000000e-01 9.000000e-01
5.000000e-01 9.000000e-01
1.000000e-01 1.000000e+00
0.000000e+00 1.000000e+00
2.000000e-01 1.000000e+00
3.000000e-01 1.000000e+00
4.000000e-01 1.000000e+00
5.000000e-01 1.000000e+00
1.000000e+00 0.000000e+00
1.100000e+00 0.000000e+00
1.100000e+00 1.000000e-01
1.000000e+00 1.000000e-01
1.200000e+00 0.000000e+00
1.200000e+00 1.000000e-01
1.300000e+00 0.000000e+00
1.300000e+00 1.000000e-01
1.400000e+00 0.000000e+00
1.400000e+00 1.000000e-01
1.500000e+00 0.000000e+00
1.500000e+00 1.000000e-01
1.100000e+00 2.000000e-01
1.000000e+00 2.000000e-01
1.200000e+00 2.000000e-01
1.300000e+00 2.000000e-01
1.400000e+00 2.000000e-01
1.500000e+00 2.000000e-01
1.100000e+00 3.000000e-01
1.000000e+00 3.000000e-01
1.200000e+00 3.000000e-01
1.300000e+00 3.000000e-01
1.400000e+00 3.000000e-01
1.500000e+00 3.000000e-01
1.100000e+00 4.000000e-01
1.000000e+00 4.000000e-01
1.200000e+00 4.000000e-01
1.300000e+00 4.000000e-01
1.400000e+00 4.000000e-01
1.500000e+00 4.000000e-01
1.100000e+00 5.000000e-01
1.000000e+00 5.000000e-01
1.200000e+00 5.000000e-01
1.300000e+00 5.000000e-01
1.400000e+00 5.000000e-01
1.500000e+00 5.000000e-01
1.100000e+00 6.000000e-01
1.000000e+00 6.000000e-01
1.200000e+00 6.000000e-01
1.300000e+00 6.000000e-01
1.400000e+00 6.000000e-01
1.500000e+00 6.000000e-01
1.100000e+00 7.000000e-01
1.000000e+00 7.000000e-01
1.200000e+00 7.000000e-01
1.300000e+00 7.000000e-01
1.400000e+00 7.000000e-01
1.500000e+00 7.000000e-01
1.100000e+00 8.000000e-01
1.000000e+00 8.000000e-01
1.200000e+00 8.000000e-01
1.300000e+00 8.000000e-01
1.400000e+00 8.000000e-01
1.500000e+00 8.000000e-01
1.100000e+00 9.000000e-01
1.000000e+00 9.000000e-01
1.200000e+00 9.000000e-01
1.300000e+00 9.000000e-01
1.400000e+00 9.000000e-01
1.500000e+00 9.000000e-01
1.100000e+00 1.000000e+00
1.000000e+00 1.000000e+00
1.200000e+00 1.000000e+00
1.300000e+00 1.000000e+00
1.400000e+00 1.000000e+00
1.500000e+00 1.000000e+00
6.000000e-01 6.000000e-01
6.000000e-01 7.000000e-01
7.000000e-01 6.000000e-01
7.000000e-01 7.000000e-01
8.000000e-01 6.000000e-01
8.000000e-01 7.000000e-01
9.000000e-01 6.000000e-01
9.000000e-01 7.000000e-01
6.000000e-01 8.000000e-01
7.000000e-01 8.000000e-01
8.000000e-01 8.000000e-01
9.000000e-01 8.000000e-01
6.000000e-01 9.000000e-01
7.000000e-01 9.000000e-01
8.000000e-01 9.000000e-01
9.000000e-01 9.000000e-01
6.000000e-01 1.000000e+00
7.000000e-01 1.000000e+00
8.000000e-01 1.000000e+00
9.000000e-01 1.000000e+00 ]


prvky=[
       1            2            3
       1            3            4
       2            5            6
       2            6            3
       5            7            8
       5            8            6
       7            9           10
       7           10            8
       9           11           12
       9           12           10
       4            3           13
       4           13           14
       3            6           15
       3           15           13
       6            8           16
       6           16           15
       8           10           17
       8           17           16
      10           12           18
      10           18           17
      14           13           19
      14           19           20
      13           15           21
      13           21           19
      15           16           22
      15           22           21
      16           17           23
      16           23           22
      17           18           24
      17           24           23
      20           19           25
      20           25           26
      19           21           27
      19           27           25
      21           22           28
      21           28           27
      22           23           29
      22           29           28
      23           24           30
      23           30           29
      26           25           31
      26           31           32
      25           27           33
      25           33           31
      27           28           34
      27           34           33
      28           29           35
      28           35           34
      29           30           36
      29           36           35
      32           31           37
      32           37           38
      31           33           39
      31           39           37
      33           34           40
      33           40           39
      34           35           41
      34           41           40
      35           36           42
      35           42           41
      38           37           43
      38           43           44
      37           39           45
      37           45           43
      39           40           46
      39           46           45
      40           41           47
      40           47           46
      41           42           48
      41           48           47
      44           43           49
      44           49           50
      43           45           51
      43           51           49
      45           46           52
      45           52           51
      46           47           53
      46           53           52
      47           48           54
      47           54           53
      50           49           55
      50           55           56
      49           51           57
      49           57           55
      51           52           58
      51           58           57
      52           53           59
      52           59           58
      53           54           60
      53           60           59
      56           55           61
      56           61           62
      55           57           63
      55           63           61
      57           58           64
      57           64           63
      58           59           65
      58           65           64
      59           60           66
      59           66           65
      67           68           69
      67           69           70
      68           71           72
      68           72           69
      71           73           74
      71           74           72
      73           75           76
      73           76           74
      75           77           78
      75           78           76
      70           69           79
      70           79           80
      69           72           81
      69           81           79
      72           74           82
      72           82           81
      74           76           83
      74           83           82
      76           78           84
      76           84           83
      80           79           85
      80           85           86
      79           81           87
      79           87           85
      81           82           88
      81           88           87
      82           83           89
      82           89           88
      83           84           90
      83           90           89
      86           85           91
      86           91           92
      85           87           93
      85           93           91
      87           88           94
      87           94           93
      88           89           95
      88           95           94
      89           90           96
      89           96           95
      92           91           97
      92           97           98
      91           93           99
      91           99           97
      93           94          100
      93          100           99
      94           95          101
      94          101          100
      95           96          102
      95          102          101
      98           97          103
      98          103          104
      97           99          105
      97          105          103
      99          100          106
      99          106          105
     100          101          107
     100          107          106
     101          102          108
     101          108          107
     104          103          109
     104          109          110
     103          105          111
     103          111          109
     105          106          112
     105          112          111
     106          107          113
     106          113          112
     107          108          114
     107          114          113
     110          109          115
     110          115          116
     109          111          117
     109          117          115
     111          112          118
     111          118          117
     112          113          119
     112          119          118
     113          114          120
     113          120          119
     116          115          121
     116          121          122
     115          117          123
     115          123          121
     117          118          124
     117          124          123
     118          119          125
     118          125          124
     119          120          126
     119          126          125
     122          121          127
     122          127          128
     121          123          129
     121          129          127
     123          124          130
     123          130          129
     124          125          131
     124          131          130
     125          126          132
     125          132          131
      42          133          134
      42          134           48
     133          135          136
     133          136          134
     135          137          138
     135          138          136
     137          139          140
     137          140          138
     139          104          110
     139          110          140
      48          134          141
      48          141           54
     134          136          142
     134          142          141
     136          138          143
     136          143          142
     138          140          144
     138          144          143
     140          110          116
     140          116          144
      54          141          145
      54          145           60
     141          142          146
     141          146          145
     142          143          147
     142          147          146
     143          144          148
     143          148          147
     144          116          122
     144          122          148
      60          145          149
      60          149           66
     145          146          150
     145          150          149
     146          147          151
     146          151          150
     147          148          152
     147          152          151
     148          122          128
     148          128          152
]

podpory=[
       1           1 0.000000e+00 
       2           1 0.000000e+00 
       5           1 0.000000e+00 
       7           1 0.000000e+00 
       9           1 0.000000e+00 
      11           1 0.000000e+00 
      67           1 0.000000e+00 
      68           1 0.000000e+00 
      71           1 0.000000e+00 
      73           1 0.000000e+00 
      75           1 0.000000e+00 
      77           1 0.000000e+00 
       1           2 0.000000e+00 
       2           2 0.000000e+00 
       5           2 0.000000e+00 
       7           2 0.000000e+00 
       9           2 0.000000e+00 
      11           2 0.000000e+00 
      67           2 0.000000e+00 
      68           2 0.000000e+00 
      71           2 0.000000e+00 
      73           2 0.000000e+00 
      75           2 0.000000e+00 
      77           2 0.000000e+00
      ]

sily=[
    66           2 -1.000000e+03 
   127           2 -1.000000e+03 
   128           2 -1.000000e+03 
   129           2 -1.000000e+03 
   130           2 -1.000000e+03 
   131           2 -1.000000e+03 
   149           2 -1.000000e+03 
   150           2 -1.000000e+03 
   151           2 -1.000000e+03 
   152           2 -1.000000e+03 
    61           2 -1.000000e+03 
    63           2 -1.000000e+03 
    64           2 -1.000000e+03 
    65           2 -1.000000e+03 
    62           2 -5.000000e+02 
   132           2 -5.000000e+02 
     4           1 5.000000e+02  
    14           1 5.000000e+02  
    20           1 5.000000e+02  
    26           1 5.000000e+02  
    32           1 5.000000e+02  
    38           1 5.000000e+02
    ]


% Velikost poli:
nuzlu  = size(uzly,1)
nprvku = size(prvky,1)
npodpor= size(podpory,1)
nsil   = size(sily,1)

% VYPOCET: --------------------------------

% Vypocet kodovych cisel:
kcis=zeros(nprvku,ndof*puzlu);
for i=1:nprvku
  for j=1:puzlu
    for k=1:ndof
      kcis(i, ((j-1)*ndof+k))=(prvky(i,j)-1)*ndof+k ;
    end
  end
end

% Vypis kodovych cisel
kcis

% Nulovani matic a vektoru:
velikost = nuzlu*ndof;
K = zeros(velikost);
u = zeros(velikost,1);
F = zeros(velikost,1);
x = zeros(puzlu,1);
y = zeros(puzlu,1);

% Sestaveni a lokalizace matic tuhosti:
for i=1:nprvku
	for j=1:puzlu
	  x(j) = uzly(prvky(i,j),1);
	  y(j) = uzly(prvky(i,j),2);
  end

	% Plocha prvku
	A = 0.5*(x(1)*y(2)-x(2)*y(1)+x(2)*y(3)-x(3)*y(2)+x(3)*y(1)-x(1)*y(3) );

  % kvuli kresleni:
  souradnice(:,:,i)=[x(1) y(1);x(2) y(2); x(3) y(3); x(1) y(1)];

	% Matice tuhosti:
  B=[1 0 0 0 0 0 ; 
	   0 0 0 0 1 0 ;
		 0 1 0 1 0 0 ];
  D= E/(1-nu^2) * [
	     1 nu 0 ;
			 nu 1 0 ;
			 0 0 0.5*(1-nu) ];
	S=[ x(1) y(1) 1 0 0 0 ;
	    0 0 0 x(1) y(1) 1 ;
      x(2) y(2) 1 0 0 0 ;
	    0 0 0 x(2) y(2) 1 ;
      x(3) y(3) 1 0 0 0 ;
	    0 0 0 x(3) y(3) 1 ];
  Si=inv(S);

  Ke=A*t*Si'*B'*D*B*Si;
  
	% Samotna lokalizace:
  for j=1:(puzlu*ndof)
    for k=1:(puzlu*ndof)
      K(kcis(i,j),kcis(i,k)) = K(kcis(i,j),kcis(i,k))+Ke(j,k);
    end
  end
end

% Zatizeni:
for i=1:nsil
	iuz=sily(i,1);
	ismer=sily(i,2);
	pos = (ndof*(iuz-1))+ismer;
  F(pos) = F(pos)+sily(i,3);
end

% Podpory:
for i=1:npodpor
	iuz=podpory(i,1);
	ismer=podpory(i,2);
	pos = (ndof*(iuz-1))+ismer;
  u(pos) = u(pos)+podpory(i,3);
	for j=1:velikost
    K(pos,j) = 0.0 ;
    K(j,pos) = 0.0 ;
  end
	K(pos,pos) = 1.0 ;
end

% RESENI soustavy rovnic:
u=K\F

% kvuli grafice: nasobitel deformaci:
gmult=0.01*max(x)/max(u);

maplen = 12 ; % grafika
colormap(jet(maplen)); % grafika

% Vypocet vysledku na prutech:
for i=1:nprvku
	ue  = zeros(puzlu*ndof,1);

	% Ziskani lokalnich vektoru deformaci:
	for j=1:(puzlu*ndof)
		ue(j) = u(kcis(i,j));
    end
    
  % Deformovany tvar pro kresleni:
  for j=1:puzlu
	  x(j) = uzly(prvky(i,j),1);
	  y(j) = uzly(prvky(i,j),2);
      
      xi(i,j)= uzly(prvky(i,j),1); % grafika
      yi(i,j)= uzly(prvky(i,j),2); % grafika
  end
  
  % kvuli kresleni:
  ud=ue*gmult
  souradnicedef(:,:,i)=[x(1)+ud(1) y(1)+ud(2);x(2)+ud(3) y(2)+ud(4); x(3)+ud(5) y(3)+ud(6); x(1)+ud(1) y(1)+ud(2)];

  
    
	% Vypocet pomernych deformaci a napeti:

	% Matice tuhosti:
  B=[1 0 0 0 0 0 ; 
	   0 0 0 0 1 0 ;
		 0 1 0 1 0 0 ];
  D= E/(1-nu^2) * [
	     1 nu 0 ;
			 nu 1 0 ;
			 0 0 0.5*(1-nu) ];
	S=[ x(1) y(1) 1 0 0 0 ;
	    0 0 0 x(1) y(1) 1 ;
      x(2) y(2) 1 0 0 0 ;
	    0 0 0 x(2) y(2) 1 ;
      x(3) y(3) 1 0 0 0 ;
	    0 0 0 x(3) y(3) 1 ];
  Si=inv(S);

	epsilon=B*Si*ue 
	sigma= D*epsilon
    c(i)= sigma(2); % grafika
end

% Kresleni:

%subplot(1,2,1)
%hold on
%for i=1:nprvku
%  plot(souradnice(:,1,i),souradnice(:,2,i),'-r')
%end
%axis equal
%hold off

%subplot(1,2,2)
%hold on
%for i=1:nprvku
%  plot(souradnice(:,1,i),souradnice(:,2,i),'--b')
%end

%for i=1:nprvku
%  plot(souradnicedef(:,1,i),souradnicedef(:,2,i),'-r')
%  %H(i)=area(souradnice(:,1,i),souradnice(:,2,i))
%end
%axis equal
%hold off

axis equal % grafika - plochy
cmi = min(c);
cma = max(c);
c = (((c-cmi)/ ((cma-cmi)))*maplen);
caxis([cmi cma]);
colorbar;
p = patch(xi',yi','b');
set(p,'cdatamapping','direct','facecolor','flat','cdata',c);